---
- name: Clean up virtualenv if necessary
  ansible.builtin.file:
    path: "{{ antsibull_ansible_venv }}"
    state: absent
  when: antsibull_venv_cleanup | bool

- name: Get Ansible python fact
  setup:
    filter: ansible_python

- name: Set a python version fact appropriate for the venv site-packages
  set_fact:
    _python_version: "python{{ ansible_python.version.major }}.{{ ansible_python.version.minor }}"

- name: Install the release tarball in a virtualenv so we can test it
  ansible.builtin.pip:
    name: "file://{{ _release_archive }}"
    state: present
    virtualenv: "{{ antsibull_ansible_venv }}"
    virtualenv_command: "{{ ansible_python.executable }} -m venv"

- name: Test and validate that we have the expected versions of collections, ansible-core and ansible
  include_tasks: tests/versions.yaml

- name: Install the built ansible in venv and run integration tests with it
  include_tasks: tests/nested.yaml

- name: Run ansible-test sanity --docker on installed collections with podman
  include_tasks: tests/sanity.yaml
  when: antsibull_run_sanity | bool
